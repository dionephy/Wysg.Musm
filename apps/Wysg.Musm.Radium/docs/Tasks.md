# Tasks: Radium Cumulative (Reporting Workflow + Editor + Mapping + PACS)

## Added
- [X] T621 Design study technique database schema with 8 tables in med schema: technique_prefix, technique_tech, technique_suffix, technique, technique_combination, technique_combination_item, rad_studyname_technique_combination, rad_study_technique_combination (FR-453..FR-460).
- [X] T622 Create technique_prefix table with id, prefix_text (unique), display_order, created_at (FR-453, FR-464).
- [X] T623 Create technique_tech table with id, tech_text (unique), display_order, created_at (FR-453, FR-464).
- [X] T624 Create technique_suffix table with id, suffix_text (unique), display_order, created_at (FR-453, FR-464).
- [X] T625 Create technique table with id, prefix_id (nullable FK), tech_id (required FK), suffix_id (nullable FK), created_at, unique constraint on (prefix_id, tech_id, suffix_id) (FR-454, FR-463).
- [X] T626 Create technique_combination table with id, combination_name (nullable), created_at (FR-455, FR-465).
- [X] T627 Create technique_combination_item join table with id, combination_id (FK), technique_id (FK), sequence_order, created_at, unique constraint on (combination_id, technique_id, sequence_order) (FR-455).
- [X] T628 Create rad_studyname_technique_combination table with id, studyname_id (FK), combination_id (FK), is_default (bool), created_at, unique constraint on (studyname_id, combination_id) (FR-456, FR-458).
- [X] T629 Create rad_study_technique_combination table with id, study_id (FK unique), combination_id (FK), created_at (FR-457, FR-459).
- [X] T630 Add foreign key constraints with CASCADE delete for studyname/study links and RESTRICT delete for technique component links (FR-467).
- [X] T631 Create indexes on: technique.tech_id, technique_combination_item.combination_id, technique_combination_item.technique_id, rad_studyname_technique_combination.studyname_id, rad_studyname_technique_combination.combination_id (FR-468).
- [X] T632 Create view med.v_technique_display with formatted display as "prefix tech suffix" using TRIM and CONCAT_WS (FR-461).
- [X] T633 Create view med.v_technique_combination_display with STRING_AGG joining techniques with " + " separator ordered by sequence_order (FR-462).
- [X] T634 Seed common prefixes: blank, axial, coronal, sagittal, 3D, intracranial, neck with display_order (FR-466).
- [X] T635 Seed common techs: T1, T2, GRE, SWI, DWI, CE-T1, TOF-MRA, CE-MRA, 3T with display_order (FR-466).
- [X] T636 Seed common suffixes: blank, "of sellar fossa" with display_order (FR-466).
- [X] T637 Create SQL file db\schema\technique_tables.sql with all table definitions, views, indexes, and seed data (FR-453..FR-468).
- [X] T638 Add table and column comments documenting purpose and special handling (e.g., empty string vs NULL) (FR-463).
- [X] T639 Update Spec.md with FR-453..FR-468 documenting study technique feature requirements (cumulative).
- [X] T640 Update Plan.md with change log entry for study technique database schema including approach, test plan, and risks (cumulative).
- [X] T641 Update Tasks.md with completed study technique database schema tasks (this file, cumulative).
- [ ] T642 Implement repository methods for technique component CRUD operations (future work).
- [ ] T643 Implement service layer for technique management business logic (future work).
- [ ] T644 Create UI for technique management and assignment to studynames (future work).
- [ ] T645 Wire technique display in report header and study list views (future work).
- [ ] T646 Add validation logic to enforce one default per studyname in application layer (future work).
- [X] T580 Add "Splitted" toggle button next to test button in previous report area binding to PreviousReportSplitted property (FR-415).
- [X] T581 Add first set of split controls to PreviousReportTextAndJsonPanel: Split Header button, Auto Split Header toggle, Split Conclusion button, Auto Split Conclusion toggle, Auto Split toggle (FR-416).
- [X] T582 Add "Final Conclusion" textbox to PreviousReportTextAndJsonPanel below Previous Header and Findings with two-way binding (FR-417).
- [X] T583 Create FinalConclusionText dependency property in PreviousReportTextAndJsonPanel for two-way binding (FR-418, FR-426).
- [X] T584 Add second set of split controls below Final Conclusion textbox: Split Header button, Split Conclusion button, Auto Split toggle (FR-419).
- [X] T585 Update gridSideBottom and gridBottomControl instances to bind FinalConclusionText to PreviousFinalConclusionText (FR-427).
- [X] T586 Add PreviousReportSplitted property to MainViewModel for toggle state binding (FR-415).
- [X] T587 Add AutoSplitHeader, AutoSplitConclusion, AutoSplit properties to MainViewModel for toggle bindings (FR-422, FR-423, FR-424).
- [X] T588 Add SplitHeaderCommand and SplitConclusionCommand placeholders to MainViewModel (FR-420, FR-421).
- [X] T589 Apply dark theme styling to split control buttons and toggles in PreviousReportTextAndJsonPanel (FR-425).
- [X] T590 Add using System.Windows.Input to MainViewModel.PreviousStudies.cs for ICommand support.
- [X] T591 Update Spec.md with FR-415..FR-427 documenting Previous Report Split Controls functionality (cumulative).
- [X] T592 Update Plan.md with change log entry for Previous Report Split Controls including approach, test plan, and risks (cumulative).
- [X] T593 Update Tasks.md with completed Previous Report Split Controls tasks (this file, cumulative).
- [ ] T594 Implement SplitHeaderCommand functionality to split header_and_findings content into header and findings sections (future work).
- [ ] T595 Implement SplitConclusionCommand functionality to split findings content into findings and conclusion sections (future work).
- [ ] T596 Implement auto-split functionality for AutoSplitHeader, AutoSplitConclusion, and AutoSplit toggles (future work).
- [X] T572 Separate toggles: Reverse Reports affects only gridTopChild/gridBottomControl (portrait panels).
- [X] T573 Separate toggles: Align Right affects only gridSideTop/gridSideBottom (landscape panels).
- [X] T574 Update SwapReportEditors to toggle only portrait panel Reverse states.
- [X] T575 Update UpdateGridSideLayout to toggle only landscape panel Reverse states.
- [X] T576 Documentation updates (Spec/Plan/Tasks) for separated toggle behaviors.
- [X] T577 Fix PreviousReportTextAndJsonPanel reverse: name left host as PART_LeftHost, apply Reverse on Loaded, and handle Reverse DP changed to swap columns.
- [X] T578 Wire MainWindow toggles to update gridBottomControl and gridSideBottom Reverse states correctly.
- [X] T579 Make gridTopChild/gridSideTop columns 1:1 by updating ReversibleColumnsGrid to star sizing both columns.
- [X] T566 Create reusable PreviousReportTextAndJsonPanel UserControl to eliminate duplicate code in side and bottom panels (user request 2025-01-11).
- [X] T567 Add HeaderAndFindingsText and JsonText dependency properties to PreviousReportTextAndJsonPanel for two-way binding (user request 2025-01-11).
- [X] T568 Add Reverse property to PreviousReportTextAndJsonPanel to support column swapping when reports are reversed (user request 2025-01-11).
- [X] T569 Replace duplicate XAML in gridSideBottom and gridBottomControl with PreviousReportTextAndJsonPanel instances (user request 2025-01-11).
- [X] T570 Update SwapReportEditors method to handle Reverse property of new control instances (user request 2025-01-11).
- [X] T571 Update Spec.md, Plan.md, and Tasks.md with PreviousReportTextAndJsonPanel control creation (cumulative documentation update).
- [X] T560 Change PreviousReportJson field mapping from findings/conclusion to header_and_findings/final_conclusion (user request 2025-01-11).
- [X] T561 Update MainViewModel.PreviousStudies properties: rename PreviousFindingsText to PreviousHeaderAndFindingsText, PreviousConclusionText to PreviousFinalConclusionText (user request 2025-01-11).
- [X] T562 Update MainWindow.xaml previous editor bindings to use PreviousHeaderAndFindingsText and PreviousFinalConclusionText (user request 2025-01-11).
- [X] T563 Add backward compatibility aliases PreviousFindingsText and PreviousConclusionText pointing to new property names (user request 2025-01-11).
- [X] T564 Add txtPrevHeaderAndFindingsSide TextBox to the left of txtPrevJsonSide with GridSplitter; bind to PreviousHeaderAndFindingsText (user request 2025-01-11).
- [X] T565 Update Spec.md, Plan.md, and Tasks.md with field mapping changes (cumulative documentation update).
- [X] T544 Add four header component fields to MainViewModel.Editor: chief_complaint, patient_history, study_techniques, comparison (FR-386).
- [X] T545 Implement UpdateFormattedHeader() method with conditional formatting logic per FR-387 (FR-387).
- [X] T546 Change HeaderText setter to private; header is computed from component fields (FR-390).
- [X] T547 Update UpdateCurrentReportJson() to serialize new header component fields (FR-388).
- [X] T548 Update ApplyJsonToEditors() to deserialize and apply new header component fields (FR-388).
- [X] T549 Wire component field property changes to trigger UpdateFormattedHeader() and UpdateCurrentReportJson() (FR-389).
- [X] T550 Update Spec.md with FR-386..FR-390 documenting header component fields and real-time formatting (cumulative).
- [X] T551 Update Plan.md with change log entry for header component fields including approach, test plan, and risk mitigation (cumulative).
- [X] T552 Update Tasks.md with completed header component fields tasks (this file, cumulative).
- [X] T553 Fix crash on startup: Add initialization guard to prevent UpdateFormattedHeader() from running during ViewModel construction (safety fix).
- [X] T554 JSON-driven Header Recompute: Ensure HeaderText updates in real-time when header component fields are edited via CurrentReportJson (remove suppression and recompute during JSON apply).
- [X] T555 Make header editor read-only in UI (EditorHeader IsReadOnly=True).
- [X] T556 Add left-side inputs: txtStudyRemark, txtPatientRemark, editorChiefComplaint, editorPatientHistory with two-way bindings.
- [X] T557 Expose `IsReadOnly` and `ShowLineNumbers` on `EditorControl` and flow to inner `MusmEditor`.
- [X] T558 Disable line numbers on editorChiefComplaint/editorPatientHistory.
- [X] T559 Add "Edit Study Technique" and "Edit Comparison" buttons (placeholders for future dialogs).
- [X] T526 Fix snippet option parsing to allow empty text values (e.g., `0^` for empty string choice) in CodeSnippet.ParseOptions() (FR-371).
- [X] T515 Fix snippet completion display to show "{trigger} → {description}" instead of "{trigger} → {snippet text}" in MusmCompletionData and EditorCompletionData (FR-362).
- [X] T516 Implement proper mode extraction from placeholder index prefix (1^, 2^, 3^) in CodeSnippet.Expand() method (FR-363).
- [X] T517 Add modification tracking to Session class: CurrentPlaceholderModified flag and CurrentPlaceholderOriginalText storage (FR-364, FR-365).
- [X] T518 Update SelectPlaceholder to record original placeholder text and reset modification flag when switching placeholders (FR-369).
- [X] T519 Update OnDocumentChanged to mark free-text placeholders as modified when edits occur within their bounds (FR-370).
- [X] T520 Fix ApplyFallbackAndEnd to only apply "[ ]" for unmodified free text placeholders; keep typed text if modified (FR-364).
- [X] T521 Improve key handling: allow normal typing in free-text placeholders, handle mode 1 immediate selection, mode 3 buffer accumulation (FR-366, FR-367, FR-368).
- [X] T522 Update PreviewText method to use new ParseHeader signature (three-tuple return).
- [X] T523 Update Spec.md with FR-362..FR-370 documenting snippet logic implementation fixes (cumulative).
- [X] T524 Update Plan.md with change log entry for snippet logic fixes including approach, test plan, and risk mitigation (cumulative).
- [X] T525 Update Tasks.md with completed snippet logic tasks (this file, cumulative).
- [X] T493 Add "Get HTML" button to SpyWindow → Crawl Editor toolbar and wire Click to `OnGetHtml` (FR-339).
- [X] T494 Implement `OnGetHtml` to fetch URL from clipboard (http/https), reuse shared HttpClient, and output HTML or error to `txtStatus` (FR-339, aligns with Custom Procedure `GetHTML`).
- [X] T495 Update Spec/Plan/Tasks with FR-339 entries and implementation notes.
- [X] T496 Register `CodePagesEncodingProvider` at startup to enable legacy encodings (EUC-KR/CP949) (FR-340).
- [X] T497 Implement smart HTML decoding (`HttpGetHtmlSmartAsync`) with charset detection (header → meta) and CP949 fallback when UTF-8 looks corrupted; use it for both button and procedure `GetHTML` (FR-340).
- [ ] T498 Add unit tests for smart decoding using fixture pages (UTF-8 vs CP949) and corruption heuristic.
- [X] T499 Extend `ProcedureExecutor` to support `GetHTML` for background PACS execution parity; reuse the same smart decoding helper (or shared utility).
- [ ] T500 Stream-decoding optimization for very large HTML responses (optional backlog).
- [X] T486 Add "Spy" button next to "Save Automation" in Settings → Automation tab (XAML) (FR-335).
- [X] T487 Wire `OnOpenSpy` handler in `SettingsWindow.xaml.cs` to open `SpyWindow` (owned by Settings) matching Main Window behavior (FR-335).
- [X] T488 Update Spec/Plan/Tasks with FR-335 and change log entry for Settings → Automation Spy button.
- [X] T489 Add PACS method "Get current patient remark" to SpyWindow Custom Procedures combo (Tag `GetCurrentPatientRemark`) and wire PacsService wrapper `GetCurrentPatientRemarkAsync` (FR-336).
- [X] T490 Add Custom Procedure op `Replace` (Arg1 Var, Arg2 String, Arg3 String) with presets and ExecuteSingle implementation (FR-337).
- [X] T491 Add Custom Procedure op `GetHTML` (Arg1 Var URL) with async fetch via HttpClient in ExecuteSingleAsync; integrate into Set/Run flows (FR-338).
- [X] T492 Update Spec/Plan/Tasks docs with FR-336..FR-338 entries and implementation notes.
- [X] T512 Fix `ProcedureExecutor` early-return that bypassed fallback/auto-seed and caused previous-value to persist when `GetHTML` executed.
- [X] T513 Support reading/writing procedure variables by both implicit `var{i}` and custom `OutputVar` names so `GetHTML` Arg1 Type=Var can use named variables.
- [X] T514 Register encoding provider in `ProcedureExecutor` and apply basic header/meta charset handling when decoding HTML.
- [X] T700 Procedure Split Parity: Update `ProcedureExecutor.Split` to support `re:`/`regex:` prefix, C#-style escape decoding, and CRLF retry to match SpyWindow behavior (FR-343..FR-346, acceptance: patient remark parity).
- [X] T701 Validate Patient Remark parity: With a procedure that trims trailing HTML via regex split, verify New Study "GetPatientRemark" result equals SpyWindow preview (after Trim). Document in Plan/Spec and set sample.
- [X] T702 Design dark, intuitive scrollbar UX and enumerate FR-469..FR-475 in Spec.md.
- [X] T703 Implement dark ScrollBar templates and Thumb style in `Themes/DarkTheme.xaml` with hover/drag states.
- [X] T704 Apply global `ScrollBar` and `ScrollViewer` styles so TextBox/DataGrid/Editor/Combo popup inherit styling.
- [X] T705 Validate paging on track click, 12px thickness, rounded thumb, and contrast across common controls; fix any XAML issues.
- [X] T706 Update Spec.md, Plan.md, and Tasks.md with scrollbar UX changes (cumulative docs update).
- [X] T707 Fix short scrollbar length: remove fixed along-axis size from `Dark.Scrollbar.ThumbStyle` and keep only cross-axis thickness in orientation templates (FR-476).
- [X] T708 Increase minimum thumb length: set `MinHeight` (vertical) and `MinWidth` (horizontal) to 36px in templates to improve usability while keeping proportional behavior (FR-477).
- [X] T709 Edit Study Technique layout: convert to left/right panels with GridSplitter; left uses rows (Add Technique [Auto], Current Combination [*]); right shows studyname combinations with Set Default (FR-478, FR-479).
- [X] T710 Fix ComboBox selected text: update dark ComboBox template to use SelectedItem.Text via PriorityBinding and set TextSearch.TextPath=Text (FR-480).
- [X] T711 Inline add for Prefix/Tech/Suffix: add "+" buttons with prompt, call VM methods to persist and reload, auto-select new item (FR-481, FR-482).
- [X] T725 Add `AddPreviousStudy` to Settings → Automation available modules.
- [X] T726 Implement `RunAddPreviousStudyModuleAsync` and map small `+` to run `AutomationAddStudySequence` (known modules only).
- [X] T730 SpyWindow: add PACS method `InvokeOpenStudy` (label: "Invoke open study") to Custom Procedures combo (FR-516).
- [X] T731 PacsService: add `InvokeOpenStudyAsync()` that executes `InvokeOpenStudy` procedure (FR-517).
- [X] T732 ProcedureExecutor: auto-seed default for `InvokeOpenStudy` with single `Invoke` op on `SelectedStudyInSearch` (FR-518).
- [X] T733 Custom Procedure op `Invoke`: ensure Arg1 Type preset to `Element` and Arg2/Arg3 disabled in editor; support in headless executor (FR-519..FR-521).

## Verification
- [X] V190 Resize Edit Study Technique window; verify groups and list stretch with window.
- [X] V191 Select combo items; verify selected area shows friendly text.
- [X] V192 Add new prefix/tech/suffix; verify row persists and selection applied.
- [X] V193 Save combination then set default for studyname; verify refresh.
- [X] V200 SpyWindow shows "Invoke open study" in PACS Method list; selecting it loads/saves steps.
- [X] V201 Running the procedure invokes UIA `Invoke` (or `Toggle`) on selected row; viewer opens where supported.
- [X] V202 PacsService.InvokeOpenStudyAsync() returns without exception and triggers the action.

## Previously Added
- [X] T707 Fix short scrollbar length (remove along-axis size in Thumb style) (FR-476).
- [X] T708 Increase min thumb length (MinHeight/MinWidth = 36px) (FR-477).

---
## Validation Checklist
- [X] FR-478..FR-482 implemented; window resizes properly; selection text fixed; inline add works.
- [X] DarkTheme ComboBox change verified in Edit Study Technique; no regressions detected in other common ComboBoxes (to be observed).
- [X] Build passes.

## New (2025-10-13)
- [X] T720 Implement `TechniqueFormatter.BuildGroupedDisplay` to group by (prefix, suffix) and join techs with ","; join groups by ";".
- [X] T721 Extend TechniqueRepository with `GetDefaultCombinationForStudynameAsync`, `GetCombinationItemsAsync`, and `GetStudynameIdByNameAsync`.
- [X] T722 Autofill current study `StudyTechniques` in NewStudyProcedure after PACS fetch using default combination (if present).
- [X] T723 Add `MainViewModel.RefreshStudyTechniqueFromDefaultAsync` and call after closing StudynameTechniqueWindow and after saving new default.
- [X] T724 Prevent duplicate (prefix,tech,suffix) within a single combination in `StudyTechniqueViewModel` at add-time and save-time.
