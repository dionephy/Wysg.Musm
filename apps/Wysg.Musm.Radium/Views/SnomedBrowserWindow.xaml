<Window x:Class="Wysg.Musm.Radium.Views.SnomedBrowserWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Wysg.Musm.Radium.ViewModels"
        xmlns:converters="clr-namespace:Wysg.Musm.Radium.Converters"
        Title="SNOMED CT Browser" 
        Height="800" 
        Width="1200" 
        WindowStartupLocation="CenterOwner"
        Background="#1E1E1E" 
        Foreground="#E8E8E8">
    <Window.Resources>
        <Color x:Key="ClrSurface">#262A30</Color>
        <Color x:Key="ClrSurfaceAlt">#30353D</Color>
        <Color x:Key="ClrAccent">#4C8DFF</Color>
        <Color x:Key="ClrAccentAlt">#2F6DD0</Color>
        <SolidColorBrush x:Key="BrushSurface" Color="{StaticResource ClrSurface}"/>
        <SolidColorBrush x:Key="BrushSurfaceAlt" Color="{StaticResource ClrSurfaceAlt}"/>
        <SolidColorBrush x:Key="BrushAccent" Color="{StaticResource ClrAccent}"/>
        <SolidColorBrush x:Key="BrushAccentAlt" Color="{StaticResource ClrAccentAlt}"/>
        <SolidColorBrush x:Key="BrushBorder" Color="#454A52"/>
        <SolidColorBrush x:Key="BrushTextPrimary" Color="#F5F6F7"/>
        <SolidColorBrush x:Key="BrushTextSecondary" Color="#C8C8C8"/>
        <SolidColorBrush x:Key="BrushSuccess" Color="#90EE90"/>
        
        <!-- Domain converter for RadioButtons -->
        <converters:DomainEqualsConverter x:Key="DomainEqualsConverter"/>
        
        <!-- Synonym structure/entire highlighter -->
        <converters:SynonymStructureHighlightConverter x:Key="SynonymStructureHighlightConverter"/>
        
        <!-- Expander converters -->
        <converters:ExpanderArrowConverter x:Key="ExpanderArrowConverter"/>
        <converters:ExpandedToVisibilityConverter x:Key="ExpandedToVisibilityConverter"/>
        
        <Style TargetType="Button">
            <Setter Property="Background" Value="{StaticResource BrushSurfaceAlt}"/>
            <Setter Property="Foreground" Value="{StaticResource BrushTextPrimary}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BrushBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="FontSize" Value="13"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{StaticResource BrushAccent}"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Opacity" Value="0.45"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        
        <Style TargetType="RadioButton">
            <Setter Property="Foreground" Value="{StaticResource BrushTextPrimary}"/>
            <Setter Property="Margin" Value="10,0"/>
        </Style>
        
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource BrushTextSecondary}"/>
        </Style>
        
        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{StaticResource BrushSurfaceAlt}"/>
            <Setter Property="Foreground" Value="{StaticResource BrushTextPrimary}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BrushBorder}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="4"/>
        </Style>
    </Window.Resources>
    
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Domain Filter Section -->
        <Border Grid.Row="0" 
                BorderBrush="{StaticResource BrushBorder}" 
                BorderThickness="1" 
                Padding="12" 
                Margin="0,0,0,10"
                Background="{StaticResource BrushSurfaceAlt}">
            <StackPanel>
                <TextBlock Text="Select Domain:" 
                           FontWeight="Bold" 
                           FontSize="14"
                           Foreground="{StaticResource BrushTextPrimary}"
                           Margin="0,0,0,8"/>
                
                <WrapPanel>
                    <RadioButton Content="All" 
                                 Checked="OnDomainRadioButtonChecked" Tag="all"
                                 IsChecked="{Binding SelectedDomain, Mode=OneWay, Converter={StaticResource DomainEqualsConverter}, ConverterParameter=all}"/>
                    <RadioButton Content="Body Structure" 
                                 Checked="OnDomainRadioButtonChecked" Tag="body structure"
                                 IsChecked="{Binding SelectedDomain, Mode=OneWay, Converter={StaticResource DomainEqualsConverter}, ConverterParameter=body structure}"/>
                    <RadioButton Content="Finding" 
                                 Checked="OnDomainRadioButtonChecked" Tag="finding"
                                 IsChecked="{Binding SelectedDomain, Mode=OneWay, Converter={StaticResource DomainEqualsConverter}, ConverterParameter=finding}"/>
                    <RadioButton Content="Disorder" 
                                 Checked="OnDomainRadioButtonChecked" Tag="disorder"
                                 IsChecked="{Binding SelectedDomain, Mode=OneWay, Converter={StaticResource DomainEqualsConverter}, ConverterParameter=disorder}"/>
                    <RadioButton Content="Procedure" 
                                 Checked="OnDomainRadioButtonChecked" Tag="procedure"
                                 IsChecked="{Binding SelectedDomain, Mode=OneWay, Converter={StaticResource DomainEqualsConverter}, ConverterParameter=procedure}"/>
                    <RadioButton Content="Observable Entity" 
                                 Checked="OnDomainRadioButtonChecked" Tag="observable entity"
                                 IsChecked="{Binding SelectedDomain, Mode=OneWay, Converter={StaticResource DomainEqualsConverter}, ConverterParameter=observable entity}"/>
                    <RadioButton Content="Substance" 
                                 Checked="OnDomainRadioButtonChecked" Tag="substance"
                                 IsChecked="{Binding SelectedDomain, Mode=OneWay, Converter={StaticResource DomainEqualsConverter}, ConverterParameter=substance}"/>
                </WrapPanel>
            </StackPanel>
        </Border>

        <!-- Pagination Controls -->
        <Border Grid.Row="1" 
                BorderBrush="{StaticResource BrushBorder}" 
                BorderThickness="1" 
                Padding="12" 
                Margin="0,0,0,10"
                Background="{StaticResource BrushSurface}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="? Previous" 
                            Command="{Binding PreviousPageCommand}"
                            MinWidth="100"/>
                    <TextBlock Text="{Binding PageInfo}" 
                               VerticalAlignment="Center"
                               Foreground="{StaticResource BrushTextPrimary}"
                               FontWeight="Bold"
                               FontSize="14"
                               Margin="15,0"/>
                    <Button Content="Next ?" 
                            Command="{Binding NextPageCommand}"
                            MinWidth="100"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="Jump to page:" 
                               VerticalAlignment="Center"
                               Foreground="{StaticResource BrushTextPrimary}"
                               Margin="0,0,8,0"/>
                    <TextBox Text="{Binding JumpToPage, UpdateSourceTrigger=PropertyChanged}" 
                             Width="60"
                             VerticalAlignment="Center"/>
                    <Button Content="Go" 
                            Command="{Binding JumpToPageCommand}"
                            MinWidth="60"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Concepts and Terms List -->
        <ScrollViewer Grid.Row="2" 
                      VerticalScrollBarVisibility="Auto"
                      Background="{StaticResource BrushSurface}">
            <ItemsControl ItemsSource="{Binding Concepts}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <!-- Concept Group -->
                        <Border BorderBrush="{StaticResource BrushBorder}" 
                                BorderThickness="1" 
                                Margin="0,0,0,10">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Background" Value="{StaticResource BrushSurfaceAlt}"/>
                                    <Style.Triggers>
                                        <!-- Dark red background if concept has existing phrases -->
                                        <DataTrigger Binding="{Binding HasExistingPhrases}" Value="True">
                                            <Setter Property="Background" Value="#3A1010"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <StackPanel>
                                <!-- Concept Header with Expand/Collapse Button -->
                                <Border Background="{StaticResource BrushSurface}" 
                                        Padding="8">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Expand/Collapse Toggle Button -->
                                        <Button Grid.Column="0"
                                                Content="{Binding IsExpanded, Converter={StaticResource ExpanderArrowConverter}}"
                                                Command="{Binding DataContext.ToggleExpandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                MinWidth="25"
                                                Padding="4,2"
                                                Margin="0,0,8,0"
                                                FontSize="12"
                                                ToolTip="Click to expand/collapse terms"/>

                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding ConceptIdDisplay}" 
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource BrushAccent}"
                                                   FontFamily="Consolas"
                                                   Margin="0,0,10,0"/>

                                        <TextBlock Grid.Column="2"
                                                   Text="{Binding Concept.Fsn}" 
                                                   FontWeight="Bold"
                                                   Foreground="{StaticResource BrushTextPrimary}"
                                                   TextWrapping="Wrap"/>

                                        <Border Grid.Column="3"
                                                Background="#40FFFFFF"
                                                Padding="6,2"
                                                CornerRadius="2">
                                            <TextBlock Text="{Binding SemanticTag}" 
                                                       FontSize="10"
                                                       Foreground="{StaticResource BrushTextPrimary}"/>
                                        </Border>
                                    </Grid>
                                </Border>

                                <!-- Terms List (collapsed when IsExpanded=false) -->
                                <ItemsControl ItemsSource="{Binding Terms}" 
                                              Margin="8"
                                              Visibility="{Binding IsExpanded, Converter={StaticResource ExpandedToVisibilityConverter}}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="{StaticResource BrushBorder}" 
                                                    BorderThickness="0,0,0,1" 
                                                    Padding="8,6">
                                                <Border.Background>
                                                    <MultiBinding Converter="{StaticResource SynonymStructureHighlightConverter}">
                                                        <Binding Path="Term"/>
                                                        <Binding Path="TermType"/>
                                                    </MultiBinding>
                                                </Border.Background>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="60"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>

                                                    <TextBlock Grid.Column="0"
                                                               Text="{Binding TermType}" 
                                                               FontWeight="Bold"
                                                               FontSize="11"
                                                               Foreground="#FFD580"
                                                               VerticalAlignment="Center"/>

                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding Term}" 
                                                               Foreground="{StaticResource BrushTextPrimary}"
                                                               TextWrapping="Wrap"
                                                               VerticalAlignment="Center"
                                                               Margin="10,0"/>

                                                    <Button Grid.Column="2"
                                                            Content="{Binding AddButtonText}"
                                                            Command="{Binding AddCommand}"
                                                            MinWidth="80"
                                                            VerticalAlignment="Center">
                                                        <Button.Style>
                                                            <Style TargetType="Button" BasedOn="{StaticResource {x:Type Button}}">
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsAdded}" Value="True">
                                                                        <Setter Property="Background" Value="{StaticResource BrushSuccess}"/>
                                                                        <Setter Property="Foreground" Value="#000000"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Status Bar -->
        <Border Grid.Row="3" 
                BorderBrush="{StaticResource BrushBorder}" 
                BorderThickness="0,1,0,0" 
                Padding="12,8" 
                Margin="0,10,0,0"
                Background="{StaticResource BrushSurfaceAlt}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                           Text="Status:"
                           FontWeight="Bold"
                           Foreground="{StaticResource BrushTextPrimary}"
                           Margin="0,0,10,0"/>

                <TextBlock Grid.Column="1"
                           Text="{Binding StatusMessage}"
                           Foreground="{StaticResource BrushTextSecondary}"/>

                <Button Grid.Column="2"
                        Content="Refresh"
                        Command="{Binding LoadPageCommand}"
                        MinWidth="100"/>
            </Grid>
        </Border>
    </Grid>
</Window>
