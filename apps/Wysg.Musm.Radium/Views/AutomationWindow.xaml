<Window x:Class="Wysg.Musm.Radium.Views.SpyWindow"
xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
x:Name="Root"
Title="Automation" Height="900" Width="1200"
Background="#1E1E1E" Foreground="#D0D0D0" FontFamily="Consolas">
    <Window.Resources>
        <!-- Merge external resource dictionaries -->
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="SpyWindow.Styles.xaml"/>
                <ResourceDictionary Source="SpyWindow.PacsMethodItems.xaml"/>
                <ResourceDictionary Source="SpyWindow.OperationItems.xaml"/>
                <!-- Removed KnownControlItems.xaml - now dynamic -->
            </ResourceDictionary.MergedDictionaries>
            
            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        </ResourceDictionary>
    </Window.Resources>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Top bar - PACS label only -->
        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,8">
            <TextBlock Text="PACS:" VerticalAlignment="Center" Margin="0,0,6,0"/>
            <TextBlock x:Name="txtPacsKey" Width="160" VerticalAlignment="Center"/>
        </StackPanel>

        <!-- Main TabControl -->
        <TabControl Grid.Row="1" Style="{StaticResource SpyWindowTabControlStyle}">
            <!-- UI Bookmark Tab -->
            <TabItem Header="UI Bookmark" Style="{StaticResource SpyWindowTabItemStyle}">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Controls from original top bar (minus PACS) -->
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- First row: Process, Delay, Pick buttons -->
                        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,4">
                            <TextBlock Text="Process:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <TextBox x:Name="txtProcess" Width="160" Text="" Style="{StaticResource DarkTextBox}"/>
                            <TextBlock Text="Delay(ms):" VerticalAlignment="Center" Margin="8,0,4,0"/>
                            <TextBox x:Name="txtDelay" Width="60" Text="1500" Style="{StaticResource DarkTextBox}"/>
                            <Button Content="Pick" Margin="8,0,0,0" Click="OnPick" Style="{StaticResource SpyWindowButtonStyle}"/>
                            <Button Content="Pick Web" Margin="6,0,0,0" Click="OnPickWeb" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Pick element from web browser and save with window name"/>
                            <TextBox x:Name="txtPickedPoint" Width="120" IsReadOnly="True" Margin="12,0,0,0" ToolTip="Picked point (X,Y)" Style="{StaticResource DarkTextBox}"/>
                        </StackPanel>
                        
                        <!-- Second row: Bookmark selection, Save, and management buttons -->
                        <StackPanel Orientation="Horizontal" Grid.Row="1">
                            <TextBlock Text="Bookmark:" Margin="0,0,6,0" VerticalAlignment="Center"/>
                            <ComboBox x:Name="cmbKnown" Width="240" SelectionChanged="OnKnownSelectionChanged"
                                      Style="{StaticResource SpyWindowComboBoxStyle}" 
                                      ItemsSource="{Binding BookmarkItems, RelativeSource={RelativeSource AncestorType=Window}}"
                                      DisplayMemberPath="Name"/>
                            <Button Content="Save" Margin="6,0,0,0" Click="OnSaveEdited" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Save current chain to selected bookmark"/>
                            <Button Content="+" Margin="12,0,0,0" Click="OnAddBookmark" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Add new bookmark"/>
                            <Button Content="Rename" Margin="6,0,0,0" Click="OnRenameBookmark" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Rename selected bookmark"/>
                            <Button Content="Delete" Margin="6,0,0,0" Click="OnDeleteBookmark" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Delete selected bookmark"/>
                            <Separator Margin="12,0" Width="10"/>
                            <Button Content="Export KnownControls" Margin="0,0,0,0" Click="OnExportKnownControls" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Export all hardcoded KnownControl mappings as regular bookmarks" Background="#3C5C00"/>
                        </StackPanel>
                    </Grid>

                    <!-- Crawl Editor -->
                    <GroupBox Grid.Row="1" Header="Crawl Editor" Style="{StaticResource SpyWindowGroupBoxStyle}">
            <DockPanel>
                <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="0,0,0,6">
                    <TextBlock Text="Map Method:" VerticalAlignment="Center"/>
                    <ComboBox x:Name="cmbMethod" Width="150" Margin="6,0,12,0" Style="{StaticResource SpyWindowComboBoxStyle}">
                        <ComboBoxItem Tag="Chain">Chain</ComboBoxItem>
                        <ComboBoxItem Tag="AutomationIdOnly">AutomationIdOnly</ComboBoxItem>
                    </ComboBox>
                    <Button Content="Validate" Click="OnValidateChain" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="SetFocus" Margin="6,0,0,0" Click="OnSetFocus" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Invoke" Margin="6,0,0,0" Click="OnInvoke" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Get Text" Margin="6,0,0,0" Click="OnGetText" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Get Name" Margin="6,0,0,0" Click="OnGetName" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Get HTML" Margin="6,0,0,0" Click="OnGetHtml" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Row Data" Margin="6,0,0,0" Click="OnGetSelectedRow" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Separator Margin="12,0" Width="10"/>
                    <Button Content="Move Up" Click="OnMoveUp" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Move Down" Margin="6,0,0,0" Click="OnMoveDown" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Insert Above" Margin="6,0,0,0" Click="OnInsertAbove" Style="{StaticResource SpyWindowButtonStyle}"/>
                    <Button Content="Delete" Margin="6,0,0,0" Click="OnDeleteNode" Style="{StaticResource SpyWindowButtonStyle}"/>
                </StackPanel>

                <DataGrid x:Name="gridChain" AutoGenerateColumns="False" HeadersVisibility="Column" 
                          CanUserAddRows="True" CanUserDeleteRows="True" IsReadOnly="False" 
                          CellEditEnding="OnGridCellEditEnding" Style="{StaticResource SpyWindowDataGridStyle}">
                    <DataGrid.Resources>
                            <Style TargetType="CheckBox" BasedOn="{StaticResource DarkCheckBox}">
                                <EventSetter Event="Click" Handler="OnTemplateCheckBoxClick"/>
                            </Style>
                            <Style TargetType="ComboBox" BasedOn="{StaticResource SpyWindowComboBoxStyle}">
                                <EventSetter Event="SelectionChanged" Handler="OnTemplateComboSelectionChanged"/>
                            </Style>
                        </DataGrid.Resources>
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="Scope" Width="105">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <ComboBox SelectedIndex="{Binding LocateIndex, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                  Width="100" Style="{StaticResource SpyWindowComboBoxStyle}">
                                            <ComboBoxItem Content="Exclude"/>
                                            <ComboBoxItem Content="Children"/>
                                            <ComboBoxItem Content="Descendants"/>
                                        </ComboBox>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Name" Width="220">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <CheckBox IsChecked="{Binding UseName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                      VerticalAlignment="Center" Style="{StaticResource DarkCheckBox}"/>
                                            <TextBox Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                     Width="160" Margin="6,0,0,0" Style="{StaticResource DarkTextBox}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="ClassName" Width="260">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <CheckBox IsChecked="{Binding UseClassName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                      VerticalAlignment="Center" Style="{StaticResource DarkCheckBox}"/>
                                            <TextBox Text="{Binding ClassName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                     Width="180" Margin="6,0,0,0" Style="{StaticResource DarkTextBox}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="ControlTypeId" Width="180">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <CheckBox IsChecked="{Binding UseControlTypeId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                      VerticalAlignment="Center" Style="{StaticResource DarkCheckBox}"/>
                                            <TextBox Text="{Binding ControlTypeId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                     Width="100" Margin="6,0,0,0" Style="{StaticResource DarkTextBox}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="AutomationId" Width="240">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <CheckBox IsChecked="{Binding UseAutomationId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                      VerticalAlignment="Center" Style="{StaticResource DarkCheckBox}"/>
                                            <TextBox Text="{Binding AutomationId, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                     Width="160" Margin="6,0,0,0" Style="{StaticResource DarkTextBox}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTemplateColumn Header="Index" Width="70">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal">
                                            <CheckBox IsChecked="{Binding UseIndex, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                      VerticalAlignment="Center" Style="{StaticResource DarkCheckBox}"/>
                                            <TextBox Text="{Binding IndexAmongMatches, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                                     Width="40" Margin="6,0,0,0" Style="{StaticResource DarkTextBox}"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </GroupBox>
                </Grid>
            </TabItem>

            <!-- Procedure Tab -->
            <TabItem Header="Procedure" Style="{StaticResource SpyWindowTabItemStyle}">
                <DockPanel Margin="8">
                <StackPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                    <!-- First row: Procedure selection and management -->
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                        <TextBlock Text="Custom Procedure:" VerticalAlignment="Center"/>
                        <ComboBox x:Name="cmbProcMethod" Width="220" Margin="6,0,12,0"
                                  Style="{StaticResource SpyWindowComboBoxStyle}" 
                                  ItemsSource="{Binding PacsMethods, RelativeSource={RelativeSource AncestorType=Window}}"
                                  DisplayMemberPath="Name"
                                  SelectedValuePath="Tag"
                                  SelectionChanged="OnProcMethodChanged"/>
                        <Button Content="Save procedure" Margin="0,0,0,0" Click="OnSaveProcedure" Style="{StaticResource SpyWindowButtonStyle}"/>
                        <Separator Margin="12,0" Width="10"/>
                        <Button Content="Add procedure" Click="OnAddPacsMethod" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Add new custom procedure"/>
                        <Button Content="Edit procedure" Margin="6,0,0,0" Click="OnEditPacsMethod" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Edit selected custom procedure"/>
                        <Button Content="Delete procedure" Margin="6,0,0,0" Click="OnDeletePacsMethod" Style="{StaticResource SpyWindowButtonStyle}" ToolTip="Delete selected custom procedure"/>
                    </StackPanel>
                    <!-- Second row: Operation management -->
                    <StackPanel Orientation="Horizontal">
                        <Button Content="Add operation" Click="OnAddProcRow" Style="{StaticResource SpyWindowButtonStyle}"/>
                        <Button Content="Run procedure" Margin="6,0,0,0" Click="OnRunProcedure" Style="{StaticResource SpyWindowButtonStyle}"/>
                    </StackPanel>
                </StackPanel>
                <DataGrid x:Name="gridProcSteps" AutoGenerateColumns="False" CanUserAddRows="False" CanUserDeleteRows="False"
                          VirtualizingPanel.IsVirtualizing="True" VirtualizingPanel.VirtualizationMode="Recycling"
                          Style="{StaticResource SpyWindowDataGridStyle}">
                    <DataGrid.Columns>
                        <DataGridTemplateColumn Header="Operation" Width="150">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox SelectedValuePath="Content"
                                              SelectedValue="{Binding Op, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                              Width="140" IsEditable="False" StaysOpenOnEdit="True"
                                              PreviewMouseLeftButtonDown="OnOpComboPreviewMouseDown"
                                              PreviewKeyDown="OnOpComboPreviewKeyDown"
                                              SelectionChanged="OnProcOpChanged"
                                              Style="{StaticResource SpyWindowComboBoxStyle}"
                                              ItemsSource="{StaticResource OperationItems}"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Arg1 Type" Width="90">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox Width="80" SelectedValuePath="Content" 
                                              SelectedValue="{Binding Arg1.Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                              IsEnabled="{Binding Arg1Enabled}" Style="{StaticResource SpyWindowComboBoxStyle}">
                                        <ComboBoxItem Content="Element"/>
                                        <ComboBoxItem Content="String"/>
                                        <ComboBoxItem Content="Number"/>
                                        <ComboBoxItem Content="Var"/>
                                    </ComboBox>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Arg1" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.Resources>
                                            <Style TargetType="ComboBox" x:Key="HiddenDarkCombo" BasedOn="{StaticResource SpyWindowComboBoxStyle}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </Style>
                                        </Grid.Resources>
                                        <ComboBox Width="180" ItemsSource="{Binding DataContext.AllBookmarkTags, ElementName=Root}"
                                                  SelectedValue="{Binding Arg1.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource HiddenDarkCombo}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg1.Type}" Value="Element">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                        <ComboBox Width="180" ItemsSource="{Binding DataContext.ProcedureVars, ElementName=Root}"
                                                  SelectedValue="{Binding Arg1.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource HiddenDarkCombo}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg1.Type}" Value="Var">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                        <TextBox Width="220" Text="{Binding Arg1.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <TextBox.Style>
                                                <Style TargetType="TextBox" BasedOn="{StaticResource DarkTextBox}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Setter Property="AcceptsReturn" Value="False"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg1.Type}" Value="Element">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Arg1.Type}" Value="Var">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Arg1.Type}" Value="String">
                                                            <Setter Property="AcceptsReturn" Value="True"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBox.Style>
                                        </TextBox>
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Arg2 Type" Width="90">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox Width="80" SelectedValuePath="Content" 
                                              SelectedValue="{Binding Arg2.Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                              IsEnabled="{Binding Arg2Enabled}" Style="{StaticResource SpyWindowComboBoxStyle}">
                                        <ComboBoxItem Content="Element"/>
                                        <ComboBoxItem Content="String"/>
                                        <ComboBoxItem Content="Number"/>
                                        <ComboBoxItem Content="Var"/>
                                    </ComboBox>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Arg2" Width="*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.Resources>
                                            <Style TargetType="ComboBox" x:Key="HiddenDarkCombo2" BasedOn="{StaticResource SpyWindowComboBoxStyle}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </Style>
                                        </Grid.Resources>
                                        <ComboBox Width="180" ItemsSource="{Binding DataContext.AllBookmarkTags, ElementName=Root}"
                                                  SelectedValue="{Binding Arg2.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource HiddenDarkCombo2}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg2.Type}" Value="Element">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="IsEnabled" Value="{Binding Arg2Enabled}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                        <ComboBox Width="180" ItemsSource="{Binding DataContext.ProcedureVars, ElementName=Root}"
                                                  SelectedValue="{Binding Arg2.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource HiddenDarkCombo2}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg2.Type}" Value="Var">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="IsEnabled" Value="{Binding Arg2Enabled}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                        <TextBox Width="220" Text="{Binding Arg2.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <TextBox.Style>
                                                <Style TargetType="TextBox" BasedOn="{StaticResource DarkTextBox}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Setter Property="IsEnabled" Value="{Binding Arg2Enabled}"/>
                                                    <Setter Property="AcceptsReturn" Value="False"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg2.Type}" Value="Element">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Arg2.Type}" Value="Var">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Arg2.Type}" Value="String">
                                                            <Setter Property="AcceptsReturn" Value="True"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBox.Style>
                                        </TextBox>
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Arg3 Type" Width="90">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox Width="80" SelectedValuePath="Content" 
                                              SelectedValue="{Binding Arg3.Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                              IsEnabled="{Binding Arg3Enabled}" Style="{StaticResource SpyWindowComboBoxStyle}">
                                        <ComboBoxItem Content="Element"/>
                                        <ComboBoxItem Content="String"/>
                                        <ComboBoxItem Content="Number"/>
                                        <ComboBoxItem Content="Var"/>
                                    </ComboBox>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="Arg3" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Grid>
                                        <Grid.Resources>
                                            <Style TargetType="ComboBox" x:Key="HiddenDarkCombo3" BasedOn="{StaticResource SpyWindowComboBoxStyle}">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </Style>
                                        </Grid.Resources>
                                        <ComboBox Width="110" ItemsSource="{Binding DataContext.AllBookmarkTags, ElementName=Root}" 
                                                  SelectedValue="{Binding Arg3.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource HiddenDarkCombo3}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg3.Type}" Value="Element">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="IsEnabled" Value="{Binding Arg3Enabled}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                        <ComboBox Width="110" ItemsSource="{Binding DataContext.ProcedureVars, ElementName=Root}" 
                                                  SelectedValue="{Binding Arg3.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <ComboBox.Style>
                                                <Style TargetType="ComboBox" BasedOn="{StaticResource HiddenDarkCombo3}">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg3.Type}" Value="Var">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                            <Setter Property="IsEnabled" Value="{Binding Arg3Enabled}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </ComboBox.Style>
                                        </ComboBox>
                                        <TextBox Width="110" Text="{Binding Arg3.Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <TextBox.Style>
                                                <Style TargetType="TextBox" BasedOn="{StaticResource DarkTextBox}">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Setter Property="IsEnabled" Value="{Binding Arg3Enabled}"/>
                                                    <Setter Property="AcceptsReturn" Value="False"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Arg3.Type}" Value="Element">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Arg3.Type}" Value="Var">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Arg3.Type}" Value="String">
                                                            <Setter Property="AcceptsReturn" Value="True"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBox.Style>
                                        </TextBox>
                                    </Grid>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="OutputVar" Binding="{Binding OutputVar}" IsReadOnly="True" Width="100"/>
                        <DataGridTextColumn Header="Output" Binding="{Binding OutputPreview}" IsReadOnly="True" Width="2*"/>
                        <DataGridTemplateColumn Header="Actions" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                        <Button Content="Set" Margin="0,0,6,0" Padding="8,2" Click="OnSetProcRow" 
                                                Tag="{Binding}" Style="{StaticResource SpyWindowButtonStyle}"/>
                                        <Button Content="x" Padding="8,2" Click="OnRemoveProcRow" 
                                                Tag="{Binding}" Style="{StaticResource SpyWindowButtonStyle}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </DockPanel>
            </TabItem>

            <!-- Automation Tab (from Settings) -->
            <TabItem Header="Automation" Style="{StaticResource SpyWindowTabItemStyle}">
                <Grid Margin="8">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Header info bar (fixed at top) -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" HorizontalAlignment="Stretch" Margin="0,0,0,8">
                        <TextBlock Text="Drag modules between panes to configure execution order (duplicates allowed)." FontWeight="Bold" Foreground="#D0D0D0"/>
                        <TextBlock Text="  |  " Margin="8,0" Foreground="#B0B0B0"/>
                        <TextBlock Text="Following modalities don't send header (separated by comma):" 
                                  VerticalAlignment="Center" 
                                  Foreground="#D0D0D0" 
                                  Margin="0,0,8,0"/>
                        <TextBox x:Name="txtModalitiesNoHeaderUpdate" 
                                 VerticalAlignment="Center" 
                                 Width="150" 
                                 Style="{StaticResource DarkTextBox}"
                                 ToolTip="Enter comma-separated modality codes (e.g., XR,CR,DX) that should not update header fields"/>
                    </StackPanel>
                    
                    <!-- Main scrollable content area -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                    <!-- Top grid for module lists and shortcuts -->
                    <Grid Margin="0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- New Study / Add Study -->
                        <Border Grid.Row="0" Grid.Column="0" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="New Study" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstNewStudy" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="NewStudy" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <Border Grid.Row="0" Grid.Column="1" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Add Study" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstAddStudy" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="AddStudy" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        
                        <!-- Available Modules (right pane spans rows) with separate ScrollViewer -->
                        <Border Grid.Row="0" Grid.Column="2" Grid.RowSpan="6" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Available Modules" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                    <ListBox x:Name="lstLibrary" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="Transparent" BorderThickness="0" PreviewMouseMove="OnAutomationProcDrag" DragLeave="OnAutomationListDragLeave" Tag="Library"/>
                                </ScrollViewer>
                            </DockPanel>
                        </Border>
                        
                        <!-- Custom Modules (parallel to Available Modules) with separate ScrollViewer -->
                        <Border Grid.Row="0" Grid.Column="3" Grid.RowSpan="6" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="8,0,0,0">
                            <DockPanel>
                                <StackPanel DockPanel.Dock="Top">
                                    <TextBlock Text="Custom Modules" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                    <Button x:Name="btnCreateModule" Content="Create Module" Margin="0,0,0,8" Click="OnCreateModule" Style="{StaticResource SpyWindowButtonStyle}"/>
                                </StackPanel>
                                <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
                                    <ListBox x:Name="lstCustomModules" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="Transparent" BorderThickness="0" PreviewMouseMove="OnAutomationProcDrag" DragLeave="OnAutomationListDragLeave" Tag="CustomModules"/>
                                </ScrollViewer>
                            </DockPanel>
                        </Border>


                        <!-- Shortcut panes -->
                        <Border Grid.Row="1" Grid.Column="0" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Shortcut: Open study (new)" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstShortcutOpenNew" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="ShortcutOpenNew" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <Border Grid.Row="1" Grid.Column="1" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Shortcut: Open study (add)" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstShortcutOpenAdd" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="ShortcutOpenAdd" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <!-- Send Report pane -->
                        <Border Grid.Row="2" Grid.Column="0" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Send Report" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstSendReport" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="SendReport" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <Border Grid.Row="2" Grid.Column="1" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Shortcut: Open study (after open)" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstShortcutOpenAfterOpen" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="ShortcutOpenAfterOpen" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <!-- Send Report Preview pane -->
                        <Border Grid.Row="3" Grid.Column="0" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Send Report Preview" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstSendReportPreview" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="SendReportPreview" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <!-- Shortcut Send Report (preview) pane -->
                        <Border Grid.Row="3" Grid.Column="1" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Shortcut: Send Report (preview)" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstShortcutSendReportPreview" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="ShortcutSendReportPreview" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <!-- Shortcut Send Report (reportified) pane -->
                        <Border Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,0">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Shortcut: Send Report (reportified)" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstShortcutSendReportReportified" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="ShortcutSendReportReportified" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                        
                        <!-- Test pane -->
                        <Border Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2" BorderBrush="#3C3C3C" BorderThickness="1" CornerRadius="4" Padding="6" Background="#252526" Margin="0,0,8,8">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Top" Text="Test" FontWeight="SemiBold" Margin="0,0,0,4" Foreground="#D0D0D0"/>
                                <ListBox x:Name="lstTest" Background="#1E1E1E" Foreground="#D0D0D0" BorderBrush="#3C3C3C" AllowDrop="True" PreviewMouseMove="OnAutomationProcDrag" Drop="OnAutomationProcDrop" DragLeave="OnAutomationListDragLeave" Tag="Test" MinHeight="80" MaxHeight="150"/>
                            </DockPanel>
                        </Border>
                    </Grid>
                    </ScrollViewer>
                    
                    <!-- Fixed button bar at bottom -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,8,0,0">
                        <Button Content="Save Automation" Width="140" Margin="0,0,8,0" Click="OnSaveAutomation" Style="{StaticResource SpyWindowButtonStyle}"/>
                        <Button Content="Close" Width="90" Click="OnCloseWindow" Style="{StaticResource SpyWindowButtonStyle}"/>
                    </StackPanel>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Bottom status -->
        <TextBox Grid.Row="2" x:Name="txtStatus" IsReadOnly="True" Height="120" TextWrapping="Wrap" 
                 AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Style="{StaticResource DarkTextBox}"/>
    </Grid>
</Window>